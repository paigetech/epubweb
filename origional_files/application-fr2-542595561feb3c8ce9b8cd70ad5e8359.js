function add_item_to_folder(e,n,o){e.find(".icon.checked").hide(),e.find(".loader").show(),form_data=o.serializeArray(),form_data.push({name:"entry[folder]",value:e.data("slug")}),document_number=o.find("input#entry_document_number").val(),track_clipping_event("add",document_number,e.data("slug")),$.ajax({url:o.prop("action"),data:form_data,type:"POST"}).success(function(o){e.removeClass("not_in_folder").addClass("in_folder"),n.find(".button span.icon").addClass("clipped"),"my-clippings"==e.data("slug")?update_user_clipped_document_count(stored_document_numbers):update_user_folder_document_count(o)}).complete(function(){e.find(".loader").hide(),e.find(".icon.checked").show()})}function insert_new_folder_into_menu(e,n){$("#add-to-folder-menu-li-fr2-template")&&(template=Handlebars.compile($("#add-to-folder-menu-li-fr2-template").html()),e.find(".menu ul").append($(template(n)).css("opacity",0).animate({opacity:1},1500)))}function insert_new_folder_into_other_menu(e,n){$("#add-to-folder-menu-li-fr2-template")&&(template=Handlebars.compile($("#add-to-folder-menu-li-fr2-template").html()),new_li=$(template(n)),e.find(".menu ul").append(new_li),new_li.removeClass("in_folder").addClass("not_in_folder"),new_li.find("a").bind("click",function(e){e.preventDefault()}),new_li.bind("click",function(n){n.preventDefault(),add_item_to_folder($(this),e,e.closest("li").find("form.add_to_clipboard"))}))}function update_user_util_folders(e){update_user_folder_and_document_count(e)}function show_clippings_menu(e){$("#search ol.results")&&e.closest("div.my_fr2").closest("li").css("z-index",1100),e.addClass("hover")}function hide_clippings_menu(e){e.removeClass("hover"),$("#search ol.results")&&e.closest("div.my_fr2").closest("li").css("z-index","auto")}function display_new_folder_modal(e,n){e.unbind("mouseleave"),e.addClass("hover"),e.find(".menu li#new-folder").addClass("hover"),expect_logged_in()?$("#new-folder-modal-template")&&(modal_template=Handlebars.compile($("#new-folder-modal-template").html()),modal=$(modal_template({})),$("#new-folder-modal")&&$("#new-folder-modal").remove(),$("body").append(modal)):$("#account-needed-modal-template")&&(modal_template=Handlebars.compile($("#account-needed-modal-template").html()),modal=$(modal_template({})),$("#account-needed-modal")&&$("#account-needed-modal").remove(),$("body").append(modal)),form=modal.find("form.folder"),form.data("document-number",n),form.data("menu",e),modal.find(".jqmClose").bind("click",function(){e.bind("mouseleave",function(){hide_clippings_menu($(this))}),hide_clippings_menu(e),e.find(".menu li#new-folder").removeClass("hover")}),$(modal).jqm({modal:!0,toTop:!0,onShow:myfr2_jqmHandlers.show,onHide:myfr2_jqmHandlers.hide}),modal.jqmShow().centerScreen()}function create_new_folder(e){menu=e.data("menu"),document_number=e.data("document-number"),e.hide(),e.siblings("p").hide(),$("#new-folder-modal .folder_error").hide(),$("#new-folder-modal .folder_success").hide(),$("#new-folder-modal .folder_create").show(),form_data=e.serializeArray(),form_data.push({name:"folder[document_numbers][]",value:document_number}),$.ajax({url:e.prop("action"),data:form_data,type:"POST",beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content"))}}).success(function(n){menu.data("active-menu",!0),track_folder_event("create",1),track_clipping_event("add",document_number,e.find("input#folder_name").val()),$("#new-folder-modal .folder_create").hide(),show_folder_success(n),update_user_util_folders(n),setTimeout(function(){$("#new-folder-modal").jqmHide(),$("#new-folder-modal .folder_success").hide(),e.siblings("p").show(),e.find("input#folder_name").val(""),e.show()},1200),setTimeout(function(){insert_new_folder_into_menu(menu,n),menu.find(".button span.icon").addClass("clipped"),0!==$("body#search").length&&$("#clipping-actions.fr2 .add_to_folder").each(function(){other_menu=$(this),other_menu.data("active-menu")!==!0&&insert_new_folder_into_other_menu(other_menu,n)})},1225),setTimeout(function(){menu.bind("mouseleave",function(){hide_clippings_menu($(this))}),hide_clippings_menu(menu),menu.find(".menu li#new-folder").removeClass("hover"),menu.data("active-menu",!1)},3700)}).fail(function(n){$("#new-folder-modal .folder_create").hide(),responseText=$.parseJSON(n.responseText),$("#new-folder-modal .folder_error p .message").html(responseText.errors[0]),$("#new-folder-modal .folder_error").show(),e.siblings("p").show(),e.show()})}function remove_document_from_folder(e,n,o){e.find("a span.icon").hide(),e.find("a span.loader").show(),track_clipping_event("remove",n,e.data("slug")),$.ajax({url:"/my/folder_clippings/delete",data:{folder_clippings:{folder_slug:e.data("slug"),document_number:n}},type:"POST",beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content"))}}).success(function(n){e.removeClass("in_folder").addClass("not_in_folder"),e.find("a span.loader").hide(),e.find("a span.icon").remove(),checked_span=$("<span>").addClass("checked icon icon-fr2 icon-fr2-badge_check_mark"),e.find("a").append(checked_span),$("body").hasClass("fonts_ie7_lte")&&addIconViaJS(checked_span,"icon-fr2-badge_check_mark"),e.bind("click",function(e){e.preventDefault(),add_item_to_folder($(this),o,o.closest("li").find("form.add_to_clipboard"))}),"my-clippings"!==e.data("slug")?(documents_in_folders=$("#user_utils #document-count-holder #user_documents_in_folders_count"),documents_in_folders.html(parseInt(documents_in_folders.html(),0)-n.folder.doc_count)):(documents_in_clipboard=$("#user_utils #document-count-holder #doc_count"),documents_in_clipboard.html(parseInt(documents_in_clipboard.html(),0)-n.folder.doc_count)),set_clipped_icon_status()})}function add_in_folder_mouseenter_events(e,n,o){e.find("a span.checked.icon").remove();var d=e.find("a");goto_span=$("<span>").addClass("goto icon icon-fr2 icon-fr2-badge_forward_arrow"),d.append(goto_span),delete_span=$("<span>").addClass("delete icon icon-fr2 icon-fr2-badge_x"),d.append(delete_span),$("body").hasClass("fonts_ie7_lte")&&(addIconViaJS(goto_span,"icon-fr2-badge_forward_arrow"),addIconViaJS(delete_span,"icon-fr2-badge_x")),goto_span.bind("click",function(e){e.preventDefault(),e.stopPropagation(),folder=$(this).closest("li").data("slug"),window.location.href="/my/folders/"+folder}),delete_span.bind("click",function(d){d.preventDefault(),d.stopPropagation(),remove_document_from_folder(e,n,o)})}$(document).ready(function(){$("form.add_to_clipboard").hide(),$("form.add_to_clipboard").bind("submit",function(e){e.preventeventDefault()}),0!==$(".metadata_share_bar").length&&$(".metadata_share_bar").height($(".metadata_share_bar .metadata").height()).css("overflow","visible"),current_document_number=$("form.add_to_clipboard input#entry_document_number").val(),$("#add-to-folder-menu-fr2-template")&&(add_to_folder_menu_fr2_template=Handlebars.compile($("#add-to-folder-menu-fr2-template").html())),user_folder_details.current_document_number=current_document_number,$("div.share li.clip_for_later").each(function(){var e=current_document_number;0!==$("body#search").length&&(e=$(this).closest("div").closest("li").data("document-number"),user_folder_details.current_document_number=e);var n=$(add_to_folder_menu_fr2_template(user_folder_details));$(this).append($("<div>").addClass("fr2").prop("id","clipping-actions").append(n)),n.bind("mouseenter",function(){show_clippings_menu($(this))}),n.bind("mouseleave",function(){hide_clippings_menu($(this))}),n.on("click",".button .icon",function(){not_in_clipboard=0!==$(n).find('.menu li[data-slug="my-clippings"].not_in_folder').length,not_in_clipboard&&$(n).find('.menu li[data-slug="my-clippings"]').trigger("click")}),n.find(".menu li, .menu li a").bind("click",function(e){e.preventDefault()}),n.find(".menu li.not_in_folder").bind("click",function(e){e.preventDefault(),add_item_to_folder($(this),n,n.closest("li").find("form.add_to_clipboard"))}),0!==$("body#search").length&&void 0!==user_folder_details&&document_number_present(e,user_folder_details)&&n.find(".button span.icon").addClass("clipped"),n.find(".menu li#new-folder").bind("click",function(o){o.preventDefault(),display_new_folder_modal(n,e)}),n.on("mouseenter",".menu li.in_folder",function(){add_in_folder_mouseenter_events($(this),e,n)}),n.on("mouseleave",".menu li.in_folder",function(){var e=$(this);e.find("a span.delete.icon").remove(),e.find("a span.goto.icon").remove(),0===e.find("a span.checked.icon").length&&(checked_span=$("<span>").addClass("checked icon icon-fr2 icon-fr2-badge_check_mark"),e.find("a").append(checked_span),$("body").hasClass("fonts_ie7_lte")&&addIconViaJS(checked_span,"icon-fr2-badge_check_mark"))})}),0===$("body#search").length&&void 0!==user_folder_details&&document_number_present(current_document_number,user_folder_details)&&$("div.share li.clip_for_later #add-to-folder .button span.icon").addClass("clipped"),$("#new-folder-modal form.folder").live("submit",function(e){e.preventDefault(),create_new_folder($(this))}),$(".add_to_folder .button.tip_over").tipsy({gravity:"south",offset:3,live:!0})});